rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 메시지 컬렉션 - 모든 사용자가 읽기/쓰기 가능
    match /messages/{messageId} {
      allow read, write: if true;
    }
    
    // 사용자 컬렉션 - 인증된 사용자만 읽기/쓰기 가능
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Contact 1:1 채팅: 테스트용으로 모두 허용
    match /contact-messages/{chatId}/messages/{messageId} {
      allow read, write: if true;
    }
    
    // 기본 규칙 - 모든 접근 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

function isContactParticipant(chatId, uid) {
  // chatId는 "ANON_DEV_유저UID" 또는 "유저UID_ANON_DEV" 형식
  return chatId.matches('(.+)_ANON_DEV') && (
    uid == 'ANON_DEV' || uid == chatId.split('_')[0] || uid == chatId.split('_')[1]
  );
} 